function updateUserStatus(e){try{if(!e||!e.phone)return;const o=document.querySelector(`.user-card[data-phone="${e.phone}"]`);if(!o)return;const n=o.querySelector(".user-status");n&&(n.classList.remove("online","offline"),n.classList.add(e.connected?"online":"offline"))}catch(e){}}function setupManualCodeInput(){const e=document.getElementById("addUserForm");if(!e)return;let o=document.getElementById("manualCodeInputContainer");if(o)return;o=document.createElement("div"),o.id="manualCodeInputContainer",o.className="col-md-6 mt-3",o.innerHTML='\n        <div class="card">\n            <div class="card-header bg-info text-white">\n                <h5 class="mb-0">Inserimento manuale codice</h5>\n            </div>\n            <div class="card-body">\n                <p class="text-muted">Se non ricevi il codice sul telefono, puoi inserirlo manualmente qui:</p>\n                <div class="row g-3">\n                    <div class="col-md-6">\n                        <label for="manualPhone" class="form-label">Numero di telefono</label>\n                        <input type="text" class="form-control" id="manualPhone" placeholder="393xxxxxxxxx">\n                    </div>\n                    <div class="col-md-6">\n                        <label for="manualCode" class="form-label">Codice di verifica</label>\n                        <input type="text" class="form-control" id="manualCode" placeholder="12345">\n                    </div>\n                    <div class="col-12">\n                        <button type="button" class="btn btn-info" id="submitManualCodeBtn">\n                            <i class="bi bi-check-circle"></i> Verifica codice\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    ',e.appendChild(o);const n=document.getElementById("submitManualCodeBtn");n&&n.addEventListener("click",(function(){const e=document.getElementById("manualPhone").value.trim(),o=document.getElementById("manualCode").value.trim();if(!e||!o)return void showNotification("Errore","Inserisci sia il numero di telefono che il codice","danger");let n=localStorage.getItem(`phoneCodeHash_${e}`);if(!n)for(let e=0;e<localStorage.length;e++){const o=localStorage.key(e);if(o&&o.startsWith("phoneCodeHash_")){n=localStorage.getItem(o);break}}n||(n=prompt("Inserisci il phone_code_hash (se lo conosci, altrimenti premi Annulla):"),n)?(localStorage.setItem(`phoneCodeHash_${e}`,n),submitVerificationCode(e,o,n)):useAlternativeVerification(e,o)}))}function useAlternativeVerification(e,o){showSpinner("Verifica codice","Tentativo alternativo di verifica del codice..."),fetch("/api/users/verify-alternative",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e,code:o})}).then((e=>e.json())).then((e=>{hideSpinner(),e.success?(showNotification("Successo","Utente verificato con successo","success"),window.location.reload()):showNotification("Errore",e.message||"Errore durante la verifica del codice","danger")})).catch((e=>{hideSpinner(),showNotification("Errore","Si è verificato un errore durante la connessione al server","danger")}))}function addUser(){try{const e=document.getElementById("newUserPhone");if(!e)return;let o=e.value.trim();if(!o)return void showNotification("Errore","Inserisci un numero di telefono valido","danger");if(o.startsWith("+")&&(o=o.substring(1)),o=o.replace(/\s/g,""),!/^\d+$/.test(o))return void showNotification("Errore","Il numero di telefono deve contenere solo cifre","danger");if(!o.match(/^\d{7,15}$/))return void showNotification("Errore",'Il formato del numero non è valido. Usa il formato internazionale senza il "+", ad esempio: 393451234567',"danger");showSpinner("Aggiunta utente","Connessione a Telegram in corso..."),fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:o})}).then((e=>{if(!e.ok)throw new Error(`Error ${e.status}: ${e.statusText}`);return e.json()})).then((e=>{if(hideSpinner(),e.success)showNotification("Successo","Utente aggiunto con successo","success"),window.location.reload();else if("code_sent"===e.status){showNotification("Info",`Codice di verifica inviato a ${e.phone}`,"info"),e.phone_code_hash&&localStorage.setItem(`phoneCodeHash_${e.phone}`,e.phone_code_hash),showVerificationCodeDialog(e.phone,e.phone_code_hash),setupManualCodeInput();const o=document.getElementById("manualPhone");o&&(o.value=e.phone)}else if("password_required"===e.status)showNotification("Info","Password a due fattori richiesta","info"),show2FAPasswordDialog(e.phone);else if("flood_wait"===e.status){showNotification("Attenzione",e.message||"Limite di tempo raggiunto, riprova più tardi","warning"),showFloodWaitModal(e.phone,e.message,e.wait_seconds),setupManualCodeInput();const o=document.getElementById("manualPhone");o&&(o.value=e.phone)}else if("connection_error"===e.status)showNotification("Errore","Impossibile connettersi a Telegram. Verifica le credenziali API e la connessione Internet.","danger"),setupManualCodeInput();else if("user_exists"===e.status)showNotification("Info",`L'utente ${e.phone} è già registrato`,"info");else{const o=e.message||"Errore durante l'aggiunta dell'utente";showNotification("Errore",o,"danger"),setupManualCodeInput();const n=document.getElementById("manualPhone");n&&e.phone&&(n.value=e.phone),showErrorDetailsModal("Errore durante l'aggiunta dell'utente",o,e)}})).catch((e=>{hideSpinner(),showNotification("Errore","Si è verificato un errore durante la connessione al server","danger"),setupManualCodeInput(),showErrorDetailsModal("Errore di connessione",e.message,{error:e.toString()})}))}catch(e){hideSpinner(),showNotification("Errore","Si è verificato un errore durante l'aggiunta dell'utente","danger"),setupManualCodeInput()}}function showErrorDetailsModal(e,o,n){let t=document.getElementById("errorDetailsModal");t||(t=document.createElement("div"),t.id="errorDetailsModal",t.className="modal fade",t.setAttribute("tabindex","-1"),t.setAttribute("aria-labelledby","errorDetailsModalLabel"),t.setAttribute("aria-hidden","true"),document.body.appendChild(t)),t.innerHTML=`\n        <div class="modal-dialog modal-lg">\n            <div class="modal-content">\n                <div class="modal-header bg-danger text-white">\n                    <h5 class="modal-title" id="errorDetailsModalLabel">${e}</h5>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body">\n                    <div class="alert alert-danger">${o}</div>\n                    <h6>Dettagli tecnici:</h6>\n                    <div class="json-viewer">\n                        <pre>${JSON.stringify(n,null,2)}</pre>\n                    </div>\n                    <div class="mt-3">\n                        <p><strong>Suggerimenti per la risoluzione:</strong></p>\n                        <ul>\n                            <li>Verifica che le credenziali API di Telegram (API_ID e API_HASH) siano corrette nel file .env</li>\n                            <li>Assicurati che il numero di telefono sia formattato correttamente</li>\n                            <li>Controlla che non ci siano problemi di connessione alla rete</li>\n                            <li>Verifica che l'account Telegram sia attivo e non abbia restrizioni</li>\n                            <li>Controlla i log del server per maggiori dettagli</li>\n                        </ul>\n                    </div>\n                </div>\n                <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>\n                </div>\n            </div>\n        </div>\n    `;try{new bootstrap.Modal(t).show()}catch(e){t.classList.add("show"),t.style.display="block",document.body.classList.add("modal-open");if(!document.querySelector(".modal-backdrop")){const e=document.createElement("div");e.className="modal-backdrop fade show",document.body.appendChild(e)}}}function showFloodWaitModal(e,o,n){try{const e=new Date(Date.now()+1e3*n).toLocaleString();let t="floodWaitModal",i=document.getElementById(t);if(i){const n=i.querySelector("#floodWaitMessage"),t=i.querySelector("#floodWaitRetryTime");n&&(n.textContent=o),t&&(t.textContent=e)}else i=document.createElement("div"),i.id=t,i.className="modal fade",i.setAttribute("tabindex","-1"),i.setAttribute("aria-labelledby","floodWaitModalLabel"),i.setAttribute("aria-hidden","true"),i.innerHTML=`\n                <div class="modal-dialog">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title" id="floodWaitModalLabel">Limite di tempo Telegram</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                        </div>\n                        <div class="modal-body">\n                            <div class="alert alert-warning">\n                                <i class="bi bi-exclamation-triangle"></i> <strong>Attesa richiesta</strong>\n                            </div>\n                            <p id="floodWaitMessage">${o}</p>\n                            <p>Potrai richiedere un nuovo codice a partire da:<br>\n                            <strong id="floodWaitRetryTime">${e}</strong></p>\n                            <p class="mt-3">Questo è un limite imposto da Telegram per prevenire abusi del sistema di autenticazione.</p>\n                            <hr>\n                            <p>Se hai già un account autenticato in precedenza, puoi provare ad usare quello invece di crearne uno nuovo.</p>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>\n                        </div>\n                    </div>\n                </div>\n            `,document.body.appendChild(i);try{new bootstrap.Modal(i).show()}catch(e){i.classList.add("show"),i.style.display="block",document.body.classList.add("modal-open");if(!document.querySelector(".modal-backdrop")){const e=document.createElement("div");e.className="modal-backdrop fade show",document.body.appendChild(e)}}}catch(e){showNotification("Errore",o||"È necessario attendere prima di richiedere un nuovo codice di verifica","warning")}}function removeUser(e){try{if(!e)return;showSpinner("Rimozione utente","Rimozione dell'utente in corso..."),fetch("/api/users",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e})}).then((e=>e.json())).then((o=>{if(hideSpinner(),o.success){showNotification("Successo","Utente rimosso con successo","success");const o=document.querySelector(`.user-card[data-phone="${e}"]`);if(o){const e=o.closest(".col-md-4");e&&e.remove()}const n=document.getElementById("usersContainer");n&&!n.querySelector(".user-card")&&(n.innerHTML='<div class="alert alert-info">Nessun utente registrato</div>')}else showNotification("Errore",o.message||"Errore durante la rimozione dell'utente","danger")})).catch((e=>{hideSpinner(),showNotification("Errore","Si è verificato un errore durante la connessione al server","danger")}))}catch(e){hideSpinner(),showNotification("Errore","Si è verificato un errore durante la rimozione dell'utente","danger")}}function showVerificationCodeDialog(e,o){try{let n=document.getElementById("verificationCodeModal");if(n){const t=n.querySelector("#verificationPhone");t&&(t.value=e);const i=n.querySelector("#phoneCodeHash");i&&o&&(i.value=o),o&&(n.dataset.phoneCodeHash=o)}else{n=document.createElement("div"),n.id="verificationCodeModal",n.className="modal fade",n.setAttribute("tabindex","-1"),n.setAttribute("aria-labelledby","verificationCodeModalLabel"),n.setAttribute("aria-hidden","true"),o&&(n.dataset.phoneCodeHash=o),n.innerHTML=`\n                <div class="modal-dialog">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title" id="verificationCodeModalLabel">Verifica Telegram</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                        </div>\n                        <div class="modal-body">\n                            <p>Telegram ha inviato un codice di verifica al numero ${e}.</p>\n                            <p>Inserisci il codice ricevuto:</p>\n                            <input type="text" class="form-control" id="verificationCode" placeholder="Codice" maxlength="5">\n                            <input type="hidden" id="verificationPhone" value="${e}">\n                            <input type="hidden" id="phoneCodeHash" value="${o||""}">\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>\n                            <button type="button" class="btn btn-primary" id="submitVerificationCode">Verifica</button>\n                        </div>\n                    </div>\n                </div>\n            `,document.body.appendChild(n);const t=document.getElementById("submitVerificationCode");if(t){t.addEventListener("click",(function(){const e=document.getElementById("verificationCode").value.trim(),o=document.getElementById("verificationPhone").value,t=document.getElementById("phoneCodeHash").value||n.dataset.phoneCodeHash;e?submitVerificationCode(o,e,t):showNotification("Errore","Inserisci il codice di verifica","danger")}));const e=document.getElementById("verificationCode");e&&e.addEventListener("keyup",(function(e){"Enter"===e.key&&t.click()}))}}try{new bootstrap.Modal(n).show(),setTimeout((()=>{const e=document.getElementById("verificationCode");e&&e.focus()}),500)}catch(e){n.classList.add("show"),n.style.display="block",document.body.classList.add("modal-open");if(!document.querySelector(".modal-backdrop")){const e=document.createElement("div");e.className="modal-backdrop fade show",document.body.appendChild(e)}}}catch(e){showNotification("Errore","Si è verificato un errore durante la visualizzazione del dialog di verifica","danger")}}function show2FAPasswordDialog(e){try{let o=document.getElementById("twoFAPasswordModal");if(o){const n=o.querySelector("#twoFAPhone");n&&(n.value=e)}else{o=document.createElement("div"),o.id="twoFAPasswordModal",o.className="modal fade",o.setAttribute("tabindex","-1"),o.setAttribute("aria-labelledby","twoFAPasswordModalLabel"),o.setAttribute("aria-hidden","true"),o.innerHTML=`\n                <div class="modal-dialog">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title" id="twoFAPasswordModalLabel">Autenticazione a due fattori</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                        </div>\n                        <div class="modal-body">\n                            <p>Il tuo account Telegram richiede l'autenticazione a due fattori.</p>\n                            <p>Inserisci la password 2FA:</p>\n                            <input type="password" class="form-control" id="twoFAPassword" placeholder="Password">\n                            <input type="hidden" id="twoFAPhone" value="${e}">\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>\n                            <button type="button" class="btn btn-primary" id="submitTwoFAPassword">Verifica</button>\n                        </div>\n                    </div>\n                </div>\n            `,document.body.appendChild(o);const n=document.getElementById("submitTwoFAPassword");n&&n.addEventListener("click",(function(){const e=document.getElementById("twoFAPassword").value.trim(),o=document.getElementById("twoFAPhone").value;e?submitTwoFAPassword(o,e):showNotification("Errore","Inserisci la password 2FA","danger")}))}try{new bootstrap.Modal(o).show()}catch(e){o.classList.add("show"),o.style.display="block",document.body.classList.add("modal-open");if(!document.querySelector(".modal-backdrop")){const e=document.createElement("div");e.className="modal-backdrop fade show",document.body.appendChild(e)}}}catch(e){showNotification("Errore","Si è verificato un errore durante la visualizzazione del dialog 2FA","danger")}}function submitVerificationCode(e,o,n){try{if(!e||!o)return void showNotification("Errore","Dati incompleti per la verifica","danger");showSpinner("Verifica codice","Verifica del codice in corso...");const t=document.getElementById("verificationCodeModal");if(t)try{const e=bootstrap.Modal.getInstance(t);if(e)e.hide();else{t.classList.remove("show"),t.style.display="none",document.body.classList.remove("modal-open");const e=document.querySelector(".modal-backdrop");e&&e.remove()}}catch(e){}fetch("/api/users/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e,code:o,phone_code_hash:n})}).then((e=>e.json())).then((o=>{if(hideSpinner(),o.success)showNotification("Successo","Utente verificato con successo","success"),window.location.reload();else if("password_required"===o.status)show2FAPasswordDialog(e);else if("code_expired"===o.status)showNotification("Errore","Il codice di verifica è scaduto, richiedi un nuovo codice","warning"),requestNewCode(e);else if("code_invalid"===o.status){showNotification("Errore","Il codice di verifica non è valido, controlla e riprova","danger"),setupManualCodeInput();const o=document.getElementById("manualPhone");o&&(o.value=e)}else{showNotification("Errore",o.message||"Errore durante la verifica del codice","danger"),setupManualCodeInput();const n=document.getElementById("manualPhone");n&&(n.value=e)}})).catch((o=>{hideSpinner(),showNotification("Errore","Si è verificato un errore durante la connessione al server","danger"),setupManualCodeInput();const n=document.getElementById("manualPhone");n&&(n.value=e)}))}catch(e){hideSpinner(),showNotification("Errore","Si è verificato un errore durante l'invio del codice di verifica","danger"),setupManualCodeInput()}}function requestNewCode(e){e&&(showSpinner("Richiedi nuovo codice","Invio richiesta per un nuovo codice..."),fetch("/api/users/request-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e})}).then((e=>e.json())).then((o=>{if(hideSpinner(),!1===o.success&&"code_sent"===o.status)showNotification("Info",`Nuovo codice di verifica inviato a ${o.phone}`,"info"),o.phone_code_hash&&localStorage.setItem(`phoneCodeHash_${o.phone}`,o.phone_code_hash),showVerificationCodeDialog(o.phone,o.phone_code_hash);else if("flood_wait"===o.status){showNotification("Attenzione",o.message||"Limite di tempo raggiunto, riprova più tardi","warning"),showFloodWaitModal(o.phone,o.message,o.wait_seconds),setupManualCodeInput();const n=document.getElementById("manualPhone");n&&(n.value=e)}else{showNotification("Errore",o.message||"Errore durante la richiesta del nuovo codice","danger"),setupManualCodeInput();const n=document.getElementById("manualPhone");n&&(n.value=e)}})).catch((o=>{hideSpinner(),showNotification("Errore","Si è verificato un errore durante la richiesta del nuovo codice","danger"),setupManualCodeInput();const n=document.getElementById("manualPhone");n&&(n.value=e)})))}function submitTwoFAPassword(e,o){try{const n=document.getElementById("twoFAPasswordModal");if(n)try{const e=bootstrap.Modal.getInstance(n);if(e)e.hide();else{n.classList.remove("show"),n.style.display="none",document.body.classList.remove("modal-open");const e=document.querySelector(".modal-backdrop");e&&e.remove()}}catch(e){}showSpinner("Verifica password","Verifica della password in corso..."),fetch("/api/users/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e,password:o})}).then((e=>e.json())).then((e=>{hideSpinner(),e.success?(showNotification("Successo","Utente verificato con successo","success"),window.location.reload()):showNotification("Errore",e.message||"Errore durante la verifica della password","danger")})).catch((e=>{hideSpinner(),showNotification("Errore","Si è verificato un errore durante la connessione al server","danger")}))}catch(e){hideSpinner(),showNotification("Errore","Si è verificato un errore durante l'invio della password 2FA","danger")}}function loadActiveUsers(){fetch("/api/users").then((e=>e.json())).then((e=>{updateActiveUsersList(e)})).catch((e=>{}))}function updateActiveUsersList(e){const o=document.getElementById("activeUsersContainer");if(!o)return;if(o.innerHTML="",0===e.length)return void(o.innerHTML='<div class="alert alert-info">Nessun utente attivo</div>');const n=document.createElement("div");n.className="row",e.forEach((e=>{const o=document.createElement("div");o.className="col-md-4 mb-3",o.innerHTML=`\n            <div class="card user-card">\n                <div class="card-header d-flex align-items-center">\n                    <div class="user-avatar">\n                        <i class="bi bi-person"></i>\n                    </div>\n                    <h5 class="card-title mb-0">${e.first_name} ${e.last_name||""}</h5>\n                    <div class="user-status ${e.connected?"online":"offline"}"></div>\n                </div>\n                <div class="card-body">\n                    <p class="card-text">\n                        <i class="bi bi-phone"></i> ${e.phone}<br>\n                        <i class="bi bi-person-badge"></i> ${e.username||"N/D"}\n                    </p>\n                </div>\n            </div>\n        `,n.appendChild(o)})),o.appendChild(n)}function showSpinner(e,o){const n="spinnerModal";let t=document.getElementById(n);if(t){const t=document.getElementById(`${n}Title`),i=document.getElementById(`${n}Message`);t&&(t.textContent=e||"Caricamento"),i&&(i.textContent=o||"Operazione in corso...")}else t=document.createElement("div"),t.id=n,t.className="modal fade",t.setAttribute("tabindex","-1"),t.setAttribute("data-bs-backdrop","static"),t.setAttribute("data-bs-keyboard","false"),t.innerHTML=`\n            <div class="modal-dialog modal-dialog-centered">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <h5 class="modal-title" id="${n}Title">${e||"Caricamento"}</h5>\n                    </div>\n                    <div class="modal-body text-center">\n                        <div class="d-flex justify-content-center mb-3">\n                            <div class="spinner-border text-primary" role="status">\n                                <span class="visually-hidden">Caricamento...</span>\n                            </div>\n                        </div>\n                        <p id="${n}Message">${o||"Operazione in corso..."}</p>\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(t);try{const e=new bootstrap.Modal(t);e.show(),window.currentSpinnerModal=e}catch(e){t.classList.add("show"),t.style.display="block",document.body.classList.add("modal-open");if(!document.querySelector(".modal-backdrop")){const e=document.createElement("div");e.className="modal-backdrop fade show",document.body.appendChild(e)}window.currentSpinnerModalElement=t}}function hideSpinner(){try{if(window.currentSpinnerModal)window.currentSpinnerModal.hide(),window.currentSpinnerModal=null;else if(window.currentSpinnerModalElement){const e=window.currentSpinnerModalElement;e.classList.remove("show"),e.style.display="none",document.body.classList.remove("modal-open");const o=document.querySelector(".modal-backdrop");o&&o.remove(),window.currentSpinnerModalElement=null}}catch(e){document.body.classList.remove("modal-open");document.querySelectorAll(".modal-backdrop").forEach((e=>e.remove()))}}document.addEventListener("DOMContentLoaded",(function(){if(document.getElementById("addUserForm")){const e=document.getElementById("addUserBtn");if(e){const o=document.createElement("button");o.type="button",o.className="btn btn-outline-info ms-2",o.innerHTML='<i class="bi bi-keyboard"></i> Input manuale',o.addEventListener("click",setupManualCodeInput),e.parentNode.insertBefore(o,e.nextSibling)}}})),window.addUser=addUser,window.removeUser=removeUser,window.loadActiveUsers=loadActiveUsers,window.updateUserStatus=updateUserStatus,window.showVerificationCodeDialog=showVerificationCodeDialog,window.show2FAPasswordDialog=show2FAPasswordDialog,window.submitVerificationCode=submitVerificationCode,window.submitTwoFAPassword=submitTwoFAPassword,window.showSpinner=showSpinner,window.hideSpinner=hideSpinner,window.showFloodWaitModal=showFloodWaitModal;